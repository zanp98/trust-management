flowchart LR
  %% Focus: Blockchain & Smart Contracts
  subgraph Users[Actors]
    Eval((Evaluator Wallet))
    Reg((Regulator))
  end

  subgraph Chain[Blockchain Network]
    TxPool[(Tx Pool)]
    TG[[TrustGraph.sol]]
    ETH[(Ethereum RPC)]
  end

  subgraph Offchain[Off-chain Artifacts]
    CSV[(Results CSV)]
    VC[(Verifiable Credentials)]
    Log[(Run Manifest + Hashes)]
  end

  %% Flows
  CSV -- batchSetTrustDecisions(ids,vals) --> TG
  VC -- proof verification pre-publish --> TG
  Log -- tx hash backref --> TG
  Eval --> TxPool
  TxPool --> TG
  TG --> ETH
  Reg --> TG

  %% Threat markers
  classDef attack fill:#ffcccc,stroke:#ff0000,stroke-width:1px;
  classDef layer fill:#eef6ff,stroke:#003366,stroke-width:0.8px;
  class Chain,Offchain,Users layer;
  class TG,TxPool,CSV attack;

  %% Annotations as callouts
  TG -.-> TG_note["⚠ Unauthorized writes / role bypass\n⚠ Reentrancy / storage aliasing\n⚠ Gas-DoS on large batches"]
  CSV -.-> CSV_note["⚠ Replay of stale evaluations\n⚠ Duplicate IDs / mismatch lengths"]
  TxPool -.-> TX_note["⚠ Front-running / ordering games"]
