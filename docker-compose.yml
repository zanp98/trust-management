services:
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil", "--host", "0.0.0.0", "--port", "8545"]
    ports:
      - "8545:8545"

  fuseki:
    image: stain/jena-fuseki
    container_name: fuseki
    restart: unless-stopped
    ports:
      - "3030:3030"
    environment:
      - FUSEKI_DATASET_1=trustkb
      - ADMIN_PASSWORD=admin123
    volumes:
      - ./data:/fuseki/databases        # TDB2 podatki (persistenca)
      - ./config:/fuseki/config         # za custom konfiguracije (opcijsko)
      - ./imports:/fuseki/imports       # sem da≈° .owl/.ttl za uvoz

  aggregator:
    build:
      context: .
      dockerfile: docker/aggregator.Dockerfile
    environment:
      RPC_URL: http://anvil:8545
      CONTRACT_ADDRESS: ${CONTRACT_ADDRESS:-0x0000000000000000000000000000000000000000}
      AGGREGATOR_PRIVATE_KEY: ${AGGREGATOR_PRIVATE_KEY:-0x59c6995e998f97a5a0044966f094538c38e2f95b36f3c7a1972c569b9f298561}
      ALLOWED_NODE_ADDRESSES: ${ALLOWED_NODE_ADDRESSES:-0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266}
      AGGREGATOR_QUORUM: ${AGGREGATOR_QUORUM:-1}
      IDENTITY_MODE: ${IDENTITY_MODE:-URI}
      NAMESPACE: ${NAMESPACE:-http://example.org/trust#}
      DID_ETHR_NETWORK: ${DID_ETHR_NETWORK:-}
      DID_ALLOW_NAMES_FALLBACK: ${DID_ALLOW_NAMES_FALLBACK:-true}
      VC_PATHS: ${VC_PATHS:-credentials/issued}
      VC_PROPERTY: ${VC_PROPERTY:-hasGDPVC}
      AGGREGATOR_DEBUGPY_HOST: 0.0.0.0
      AGGREGATOR_DEBUGPY_PORT: 5679
    ports:
      - "8080:8080"
      - "5679:5679"
    command: ["python", "-Xfrozen_modules=off", "-m", "oracle.aggregator.aggregator"]
    depends_on:
      - anvil

  oracle_node:
    build:
      context: .
      dockerfile: docker/node.Dockerfile
    environment:
      RPC_URL: http://anvil:8545
      CONTRACT_ADDRESS: ${CONTRACT_ADDRESS:-0x0000000000000000000000000000000000000000}
      ORACLE_PRIVATE_KEY: ${ORACLE_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
      AGGREGATOR_ENDPOINT: http://aggregator:8080
      ONTOLOGY_PATH: ${ONTOLOGY_PATH:-ontologies/pharma-trust.owl}
      POLICIES_DIR: ${POLICIES_DIR:-policies}
      STATS_PATH: ${STATS_PATH:-state/trust_stats.json}
      IDENTITY_MODE: ${IDENTITY_MODE:-URI}
      NAMESPACE: ${NAMESPACE:-http://example.org/trust#}
      DID_ETHR_NETWORK: ${DID_ETHR_NETWORK:-}
      DID_ALLOW_NAMES_FALLBACK: ${DID_ALLOW_NAMES_FALLBACK:-true}
      FUSEKI_BASE_URL: ${FUSEKI_BASE_URL:-http://fuseki:3030}
      FUSEKI_DATASET: ${FUSEKI_DATASET:-trustkb}
      FUSEKI_USER: ${FUSEKI_USER:-admin}
      FUSEKI_PASS: ${FUSEKI_PASS:-admin123}
      FUSEKI_ACCEPT: ${FUSEKI_ACCEPT:-text/turtle}
      FUSEKI_FORMAT: ${FUSEKI_FORMAT:-turtle}
      VC_PATHS: ${VC_PATHS:-credentials/issued}
      VC_PROPERTY: ${VC_PROPERTY:-hasGDPVC}
      POLL_INTERVAL: ${ORACLE_POLL_INTERVAL:-5}
      ORACLE_DEBUGPY_HOST: 0.0.0.0
      ORACLE_DEBUGPY_PORT: 5678
    ports:
      - "5678:5678"
    command: ["python", "-Xfrozen_modules=off", "-m", "oracle.node.oracle_node"]

    depends_on:
      - aggregator
      - anvil
