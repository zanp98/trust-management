flowchart LR
  %% Focus: Evaluator & Scripts
  subgraph Eval[Evaluator Pipeline]
    RHE[run_hybrid_eval.py]
    TE[trust_evaluator_ext.py]
    IU[identity_utils.py]
    PV[publish.py]
    VCISS[issue_vc.py]
  end

  subgraph Inputs[Inputs & Policies]
    POL[(policies/*.json)]
    ST[(state/trust_stats.json)]
    RES[(results/*.csv)]
    LOG[(logs/run-*.json)]
  end

  subgraph Services[External Services]
    SPARQL[[Fuseki SPARQL]]
    ETHRPC[[Ethereum RPC]]
    DIDK[[DIDKit]]
  end

  %% Flows
  POL --> TE
  ST --> TE
  SPARQL --> RHE
  RHE --> RES
  TE --> LOG
  VCISS --> RES
  IU --> PV
  PV --> ETHRPC

  %% Threat markers
  classDef attack fill:#ffcccc,stroke:#ff0000,stroke-width:1px;
  classDef layer fill:#eef6ff,stroke:#003366,stroke-width:0.8px;
  class Eval,Inputs,Services layer;
  class POL,RES,PV attack;

  %% Annotations
  POL -.-> POL_note["⚠ Schema drift / missing fields"]
  RES -.-> RES_note["⚠ Replay / tamper without signature"]
  PV -.-> PV_note["⚠ Wrong ID normalization\n⚠ Privilege escalation in publisher"]
